name: Build SLHunt Debug APK

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  build:
    name: Build Debug APK
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install apt dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            openjdk-8-jdk \
            build-essential \
            git \
            zip \
            unzip \
            zlib1g-dev \
            libncurses5 \
            libstdc++6 \
            python3-dev \
            android-sdk-platform-tools

      - name: Add ~/.local/bin to PATH
        # use environment for subsequent steps
        run: echo "PATH=$HOME/.local/bin:$PATH" >> $GITHUB_ENV

      - name: Install pip packages (Buildozer + deps)
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install --user buildozer Cython==0.29.* requests kivy

      - name: Verify python & buildozer
        run: |
          python3 --version
          which buildozer || (echo "buildozer not found in PATH" && exit 1)
          java -version

      - name: Start Buildozer debug build
        working-directory: ${{ github.workspace }}
        # Allow long output; run buildozer in non-interactive mode
        run: |
          set -o pipefail
          buildozer -v android debug 2>&1 | tee buildozer.log

      - name: Show last build log lines
        if: always()
        run: tail -n 200 buildozer.log || true

      - name: Upload APK artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: slhunt-debug-apks
          path: |
            bin/*.apk
            bin/*.aab
            buildozer.log
          retention-days: 7